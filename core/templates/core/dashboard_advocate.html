{% extends 'core/base.html' %}
{% load static %}

{% block title %}Advocate Dashboard{% endblock %}

{% block content %}

<style>
@media(max-width: 768px) {
    .profile-card { text-align: center !important; }
    .profile-card img { margin-bottom: 15px; }
    .booking-card { padding: 10px !important; }
    .mobile-section { padding: 12px !important; }
}
</style>

<div class="service-page">
  <div class="container-fluid my-4">
    <div class="row g-3">

      <div class="col-md-4 d-none d-md-block">


        <div class="card profile-card">
          <div class="card-body text-center">

            {% if user.profile_pic %}
              <img src="{{ user.profile_pic.url }}" class="rounded-circle mb-2"
                   style="width:120px;height:120px;object-fit:cover;">
            {% else %}
              <img src="{% static 'images/default-user.png' %}" class="rounded-circle mb-2"
                   style="width:120px;height:120px;object-fit:cover;">
            {% endif %}

            <h5>{{ user.first_name }}</h5>
            <p class="small text-muted">
              {{ user.email }}
              {% if user.mobile_number %} • {{ user.mobile_number }}{% endif %}
            </p>

            <a href="{% url 'edit_profile' %}" class="btn btn-sm btn-outline-primary mb-2">Edit Profile</a>

            <hr>

            <h6>Support</h6>
            <p class="small mb-1">Phone: {{ support_contact }}</p>
            <p class="small">Email: <a href="mailto:{{ support_email }}">{{ support_email }}</a></p>
          </div>
        </div>


        <div class="card mt-3">
          <div class="card-body">
            <h6 class="text-center">Profile Details</h6>

            <p class="small mb-0"><strong>Bar Council Enrollment:</strong> {{ user.enrollment_number|default:"N/A" }}</p>
            <p class="small mb-0"><strong>Experience:</strong> {{ user.experience|default:"N/A" }} years</p>
            <p class="small"><strong>Expertise:</strong> {{ user.expertise|default:"N/A" }}</p>

          </div>
        </div>

      </div>


      <div class="col-12 col-md-8 d-none d-md-block">
        <div class="card mb-3 booking-card">
          <div class="card-body">
            <h5>Assigned Bookings</h5>

            <div class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Service</th>
                    <th>Client Status</th>
                    <th>Booking Time</th>
                    <th>Case Details</th>
                  </tr>
                </thead>
                <tbody>

                  {% for b in assigned_bookings %}
                    <tr>

                      <td>{{ b.client.first_name }}</td>

                      <td>
                        {% if b.is_urgent %}
                          <span class="badge bg-danger mb-1 d-block text-center">URGENT</span>
                        {% endif %}
                        {{ b.service.title }}
                      </td>

                      <td>
                        {% if b.assigned_advocate.id == user.id %}
                          <span class="text-success fw-bold">Active</span>
                        {% else %}
                          <span class="text-danger fw-bold">Not Active</span>
                        {% endif %}
                      </td>

                      <td>{{ b.booking_time|date:"d M Y, h:i A" }}</td>

                      <td>
                        <button class="btn btn-sm btn-outline-secondary"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#case{{ forloop.counter }}">
                          View
                        </button>

                        <div class="collapse mt-2" id="case{{ forloop.counter }}">
                          {% if b.case_details %}
                            <div class="small">{{ b.case_details }}</div>
                          {% else %}
                            <div class="small text-muted">No case details provided.</div>
                          {% endif %}
                        </div>
                      </td>

                    </tr>
                  {% empty %}
                    <tr><td colspan="6" class="text-center text-muted">No bookings assigned yet.</td></tr>
                  {% endfor %}

                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>


      <div class="d-md-none mt-3">

        <div class="card p-3 mb-3 text-center">

          {% if user.profile_pic %}
              <img src="{{ user.profile_pic.url }}"
                   class="rounded-circle mb-2 mx-auto d-block"
                   style="width:110px;height:110px;object-fit:cover;">
          {% else %}
              <img src="{% static 'images/default-user.png' %}"
                   class="rounded-circle mb-2 mx-auto d-block"
                   style="width:110px;height:110px;object-fit:cover;">
          {% endif %}

          <h5>{{ user.first_name }}</h5>
          <p class="small text-muted">
              {{ user.email }}
              {% if user.mobile_number %} • {{ user.mobile_number }}{% endif %}
          </p>

          <a href="{% url 'edit_profile' %}" class="btn btn-sm btn-outline-primary w-100 mb-2">Edit Profile</a>

          <hr>

          <h6>Support</h6>
          <p class="small mb-1">Phone: {{ support_contact }}</p>
          <p class="small">Email: <a href="mailto:{{ support_email }}">{{ support_email }}</a></p>
        </div>


        <div class="card mb-3 p-3">
          <h6 class="text-center">Profile Details</h6>

          <p class="small mb-1"><strong>Bar Council Enrollment:</strong> {{ user.enrollment_number|default:"N/A" }}</p>
          <p class="small mb-1"><strong>Experience:</strong> {{ user.experience|default:"N/A" }} years</p>
          <p class="small mb-1"><strong>Expertise:</strong> {{ user.expertise|default:"N/A" }}</p>
        </div>


        <h5 class="fw-bold mb-3">Assigned Bookings</h5>

        {% for b in assigned_bookings %}
          <div class="card mb-3 shadow-sm border rounded p-3">

            {% if b.is_urgent %}
              <span class="badge bg-danger mb-2 d-block text-center">URGENT</span>
            {% endif %}

            <p><strong>Client:</strong> {{ b.client.first_name }}</p>
            <p><strong>Service:</strong> {{ b.service.title }}</p>

            <p><strong>Status:</strong>
              {% if b.assigned_advocate.id == user.id %}
                <span class="text-success fw-bold">Active</span>
              {% else %}
                <span class="text-danger fw-bold">Not Active</span>
              {% endif %}
            </p>

            <p><strong>Booking Time:</strong> {{ b.booking_time|date:"d M Y, h:i A" }}</p>

            <p><strong>Case Details:</strong></p>

            <button class="btn btn-dark btn-sm w-100"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#caseMobile{{ forloop.counter }}">
              View Details
            </button>

            <div class="collapse mt-2" id="caseMobile{{ forloop.counter }}">
              {% if b.case_details %}
                <div class="small">{{ b.case_details }}</div>
              {% else %}
                <div class="small text-muted">No case details provided.</div>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p class="text-muted">No bookings assigned yet.</p>
        {% endfor %}

      </div>

    </div>
  </div>
</div>

{% endblock %}
